# DEMO Autopilot

## Overview

Autopilot is an event-driven execution loop that automatically runs strategies from your allowlist on incoming bar data. It is **DEMO-only** — enabling in LIVE mode is blocked at both the service and API layer.

All signals generated by Autopilot flow through the existing execution safety chain: `Strategy → OrderIntent → ExecutionRouter → RiskEngine → KillSwitch → Broker`.

## Architecture

```
BAR_RECEIVED event
       │
       ▼
 AutopilotService._on_bar_received()
       │
       ├─ Guard checks (enabled, DEMO, armed, kill switch)
       │
       ├─ Match (symbol, timeframe) to allowlist entries
       │
       ├─ Per-combo:
       │   ├─ Check cooldown (per_combo_cooldown_bars)
       │   ├─ Append bar to bounded deque
       │   ├─ Run strategy: Elite8StrategyFactory.create(bot).generate_signal()
       │   └─ If entry signal → OrderIntent → ExecutionRouter.route_intent()
       │
       └─ Rate limit: max_signals_per_minute cap
```

## Configuration

`AutopilotConfig` in `engine/solat_engine/autopilot/service.py`:

| Parameter | Default | Description |
|-----------|---------|-------------|
| `max_signals_per_minute` | 10 | Rate limit on generated signals |
| `per_combo_cooldown_bars` | 3 | Bars to wait after signal before re-evaluating combo |
| `default_size` | 0.1 | Default position size (lots) |
| `warmup_bars` | 100 | Minimum bars needed before strategy can generate signals |

## API Endpoints

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/autopilot/status` | GET | Current state + metrics |
| `/autopilot/enable` | POST | Enable autopilot (DEMO only, 403 if LIVE) |
| `/autopilot/disable` | POST | Disable autopilot |
| `/autopilot/combos` | GET | Active combos with bar buffer sizes |

## Workflow

1. **Run Walk-Forward Optimisation** — from the Optimisation screen or scheduler
2. **Generate Recommended Set** — selector filters, ranks, and diversifies combos
3. **Apply to DEMO Allowlist** — populates the allowlist with best combos
4. **Enable Autopilot** — starts processing incoming bars against allowlist
5. **Monitor** — Status screen shows combos, cycles, signals, and routed intents

## Safety Invariants

1. **LIVE fail-closed**: `enable()` checks `settings.mode != LIVE` at both service and route level
2. **Kill switch respected**: Active kill switch blocks all signal generation
3. **Rate limiting**: Signals per minute capped to prevent runaway execution
4. **Per-combo cooldown**: Prevents rapid-fire signals from same strategy/symbol pair
5. **Bounded buffers**: Bar deques use `maxlen=warmup_bars + 50` to prevent memory growth
6. **Existing safety chain**: All intents pass through `ExecutionRouter.route_intent()` which enforces risk engine checks, position limits, and the kill switch

## Events

Autopilot emits events on the EventBus (forwarded via WebSocket to UI):

- `AUTOPILOT_ENABLED` — when autopilot is enabled
- `AUTOPILOT_DISABLED` — when autopilot is disabled
- `AUTOPILOT_SIGNAL` — when a strategy generates an entry signal

## Recommended Set Pipeline

The recommended set bridges WFO results to the allowlist:

```
WFO Results → ComboSelector.select() → RecommendedSet (JSON)
                                              │
                              apply_to_demo() ─┘
                                              │
                                              ▼
                                      AllowlistManager.add_entry()
```

- Sets are stored in `data/optimization/recommendations/`
- Each set has a lifecycle: `pending → applied` or `pending → superseded`
- Applying a new set supersedes all previous "applied" sets
- LIVE mode blocking is enforced at the `apply_to_demo()` method level
